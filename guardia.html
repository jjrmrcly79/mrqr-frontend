<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Validaci√≥n Guardia</title>
  <!-- Google Font Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background: url('logos/fondo.png') center center no-repeat;
      background-size: cover;
      font-family: 'Montserrat', sans-serif;
    }
    header {
      text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    header img {
      max-height: 60px;
    }
    .container {
      max-width: 960px;
      margin: auto;
      background: rgba(255,255,255,0.9);
      padding: 30px;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .search-form {
      display: flex;
      gap: .5rem;
      margin-bottom: 20px;
    }
    .search-form input,
    .search-form button {
      flex: 1;
    }
    .panel {
      height: 60vh;
      overflow-y: auto;
      padding: 15px;
      background: #fff;
      border-radius: .5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .panel h4 {
      margin-bottom: 15px;
      font-weight: 600;
      color: #800000;
    }
    .list-group-item-action {
      cursor: pointer;
    }
    .list-group-item-action:hover {
      background-color: #f8f9fa;
    }
    .btn {
      font-weight: 600;
      border-radius: .5rem;
      transition: transform .1s ease-in-out;
    }
    .btn:hover {
      transform: scale(1.02);
    }
    .alert-secondary {
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>
    <img id="client-logo" src="" alt="Logo Cliente" />
  </header>
  <div class="container">
    <form id="buscarForm" class="search-form">
      <input type="text" id="folio" class="form-control" placeholder="ID de visita" required />
      <button type="submit" id="btnBuscar" class="btn btn-info">üîç Buscar</button>
    </form>
    <div id="resultadoVisita" class="mb-4"></div>
    <div class="row">
      <div class="col-md-6">
        <div class="panel">
          <h4><i class="bi bi-check2-circle"></i> Autorizadas</h4>
          <div id="listaAutorizadas" class="list-group"></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="panel">
          <h4><i class="bi bi-people-fill"></i> En Planta</h4>
          <div id="listaActivos" class="list-group"></div>
        </div>
      </div>
    </div>
    <div class="text-center">
      <a href="index.html" class="btn btn-secondary">üîô Regresar</a>
    </div>
  </div>
  <script>
    const BASE = 'https://jjrmrcly.app.n8n.cloud/webhook';
    const visitasMap = new Map();

    // Logo din√°mico y carga inicial
    document.addEventListener('DOMContentLoaded', () => {
      const saved = JSON.parse(localStorage.getItem('selectedClient') || 'null');
      const logo = document.getElementById('client-logo');
      if (saved) {
        logo.src = `logos/${saved.value}.png`;
        logo.alt = `Logo de ${saved.text}`;
      }
      cargarListas();
    });

    // Normalizar texto
    const normalize = v => String(v || '').replace(/^=/, '').trim();

    // Manejar b√∫squeda individual
    document.getElementById('buscarForm').addEventListener('submit', async e => {
      e.preventDefault();
      const btn = document.getElementById('btnBuscar');
      const input = document.getElementById('folio');
      btn.disabled = true; input.disabled = true;
      btn.textContent = '‚è≥';
      try {
        const id = input.value.trim();
        const res = await fetch(`${BASE}/buscar-visita?id=${encodeURIComponent(id)}`);
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        mostrarVisita(data);
      } catch {
        document.getElementById('resultadoVisita').innerHTML = '<div class="alert alert-warning">Visita no encontrada</div>';
      } finally {
        btn.disabled = false; input.disabled = false;
        btn.textContent = 'üîç Buscar';
      }
    });

    // Mostrar detalle de visita y bot√≥n de acci√≥n
    function mostrarVisita(v) {
      const cont = document.getElementById('resultadoVisita');
      cont.innerHTML = '';
      const status = normalize(v.Status || v.status).toLowerCase();
      const alertClass = status === 'en planta' ? 'alert alert-secondary' : 'alert alert-primary';
      cont.innerHTML = `<div class="${alertClass}">Status: <strong>${normalize(v.Status||v.status)}</strong></div>`;
      const btn = document.createElement('button');
      btn.className = 'btn ' + (status === 'en planta' ? 'btn-dark' : 'btn-success');
      btn.innerHTML = status === 'en planta' ? '<i class="bi bi-door-closed"></i> Registrar salida' : '<i class="bi bi-door-open"></i> Registrar entrada';
      btn.onclick = () => registrarAcceso(v.Id_Visita || v.idVisita, status === 'en planta' ? 'salida' : 'entrada');
      cont.appendChild(btn);
    }

    // Registrar acceso y recargar listas
    async function registrarAcceso(id, tipo) {
      const btn = document.querySelector('#resultadoVisita .btn');
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥'; }
      try {
        const res = await fetch(`${BASE}/registro-acceso`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ idVisita: id, tipo })
        });
        if (!res.ok) throw new Error(res.status);
        const { mensaje } = await res.json();
        alert(mensaje);
        document.getElementById('resultadoVisita').innerHTML = '';
        document.getElementById('folio').value = '';
        cargarListas();
      } catch (err) {
        console.error('Error registrarAcceso:', err);
        alert('Error al registrar ' + tipo);
      }
    }

    // Cargar y renderizar listas
    async function cargarListas() {
      try {
        const res = await fetch(`${BASE}/visitas`);
        if (!res.ok) throw new Error(res.status);
        const arr = await res.json();
        visitasMap.clear(); arr.forEach(v => visitasMap.set(v.Id_Visita||v.idVisita, v));
        renderList('listaAutorizadas', arr.filter(v => normalize(v.Status||v.status).toLowerCase() === 'autorizada'));
        renderList('listaActivos', arr.filter(v => normalize(v.Status||v.status).toLowerCase() === 'en planta'));
      } catch (err) {
        console.error('Error cargarListas:', err);
      }
    }

    // Render gen√©rico de listas
    function renderList(containerId, items) {
      const ul = document.getElementById(containerId);
      ul.innerHTML = items.length ? '' : '<div class="text-muted">No hay visitas.</div>';
      items.forEach(v => {
        const id = normalize(v.Id_Visita||v.idVisita);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        btn.innerHTML = `<span><strong>${id}</strong><br><small>${normalize(v.nombre)}</small></span><i class="bi bi-${containerId==='listaAutorizadas'?'door-open':'door-closed'}"></i>`;
        btn.onclick = () => mostrarVisita(v);
        ul.appendChild(btn);
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


